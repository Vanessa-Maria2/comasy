<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <link th:rel="stylesheet" th:href="@{/webjars/bootstrap/4.5.0/css/bootstrap.min.css}"/>
    <script th:src="@{/webjars/jquery/3.7.1/jquery.min.js}"></script>
    <link rel="stylesheet" type="text/css" th:href="@{/css/constants.css}"/>
    <link rel="stylesheet" type="text/css" th:href="@{/css/signin.css}"/>

    <!-- Inclui a folha de estilo correta com base no systemType -->
    <link rel="stylesheet" type="text/css"
          th:href="@{${#strings.concat('/css/', @environment.getProperty('systemType'), '-palette.css')}}" />
    <title>Cadastro de Usuário</title>
</head>
<body>
<!--<div th:insert="~{../static/fragments/nav-bar :: nav}"></div>-->
<div class="container" style="margin: 5%;max-width: 80%;">
    <div id="message-container"></div>
    <h1 class="mt-5">Bem vindo!</h1>
    <h3 class="mt-1 mb-5">Preencha suas informações</h3>

    <form id="residentForm" method="post" class="mb-5 signin-form">

        <!-- Campo de seleção de papel -->
        <div class="mb-3 form-group select-papel col-12 p-0">
            <label for="input-role">Selecione o Papel</label>
            <select class="form-select form-control" id="input-role" name="userAuthentication.role">
                <option th:each="role : ${roles}" th:value="${role}" th:text="${role}"></option>
            </select>
        </div>

        <!-- Campos comuns -->
        <div class="common-fields">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3 form-group">
                        <label for="input-name">Nome</label>
                        <input type="text" class="form-control" id="input-name" name="person.name">
                    </div>

                    <div class="mb-3 form-group">
                        <label for="input-cpf">CPF</label>
                        <input type="text" class="form-control" id="input-cpf" name="person.cpf">
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="mb-3 form-group">
                        <label for="input-username">Usuário</label>
                        <input type="text" class="form-control" id="input-username" name="userAuthentication.username">
                    </div>

                    <div class="mb-3 form-group">
                        <label for="input-password">Senha</label>
                        <input type="password" class="form-control" id="input-password" name="userAuthentication.password">
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="mb-3 form-group">
                        <label for="input-entry-date">Data de Entrada</label>
                        <input type="date" class="form-control" id="input-entry-date" name="userAuthentication.entryDate">
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="mb-3 form-group">
                        <label for="input-exit-date">Data de Saída</label>
                        <input type="date" class="form-control" id="input-exit-date" name="userAuthentication.exitDate">
                    </div>
                </div>
            </div>
        </div>

        <!-- Campos específicos para Resident -->
        <div class="resident-fields d-none">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3 form-group">
                        <label for="input-birthday">Data de Nascimento</label>
                        <input type="date" class="form-control" id="input-birthday" name="person.birthday">
                    </div>

                    <div class="mb-3 form-group">
                        <label for="input-apartment-number">Número do Apartamento</label>
                        <input type="text" class="form-control" id="input-apartment-number" name="apartmentNumber">
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="mb-3 form-group">
                        <label for="input-cnh">CNH</label>
                        <input type="text" class="form-control" id="input-cnh" name="person.cnh">
                    </div>

                    <div class="mb-3 form-group">
                        <label for="input-cpf-titular">CPF do Titular</label>
                        <input type="text" class="form-control" id="input-cpf-titular" name="cpfTitular">
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="mb-3 form-group">
                        <label for="input-phone">Telefone(s)</label>
                        <div id="phone-inputs">
                            <input type="text" name="person.phoneNumber" class="form-control mb-2 phone-input" placeholder="Telefone">
                        </div>
                        <button type="button" class="btn btn-primary mb-3" id="add-phone">Adicionar Telefone</button>
                    </div>
                </div>
            </div>
        </div>

        <button type="button" onclick="submitForm()" class="btn signin">Cadastrar</button>
    </form>
</div>

<script th:src="@{/webjars/jquery/3.7.1/jquery.min.js}"></script>
<script th:src="@{/webjars/bootstrap/4.5.0/js/bootstrap.min.js}"></script>
<script type="text/javascript">
    function showMessage(message, type) {
        document.getElementById('message-container').innerHTML = '<div class="alert alert-' + type + '">' + message + '</div>';

        setTimeout(() => {
            document.getElementById('message-container').innerHTML = '';
        }, 5000);
    }

    function submitForm() {
        var form = $('#residentForm')[0];
        var formData = new FormData(form);
        var residentDto = {
            person: {
                phoneNumber: []
            },
            apartmentNumber: null,
            userAuthentication: {}
        };

        formData.forEach(function (value, key) {
            if (key.startsWith('person.')) {
                var personKey = key.substring(7);
                if (personKey === 'phoneNumber') {
                    residentDto.person.phoneNumber.push(value);
                } else {
                    residentDto.person[personKey] = value;
                }
            } else if (key === 'apartmentNumber') {
                residentDto.apartmentNumber = value;
            } else if (key.startsWith('userAuthentication.')) {
                var authKey = key.substring(19);
                residentDto.userAuthentication[authKey] = value;
            } else {
                residentDto[key] = value;
            }
        });

        residentDto.person.birthday = new Date(residentDto.person.birthday);

        $.ajax({
            type: "POST",
            contentType: "application/json",
            url: "/resident",
            data: JSON.stringify(residentDto),
            dataType: 'json',
            success: function (data) {
                // showMessage('Residente criado com sucesso', 'success');
                window.location.href = '/login?message=Cadastro realizado com sucesso&type=success';
            },
            error: function (error) {
                console.log(error.responseJSON.errors);
                showMessage('Erro ao criar residente: ' + error.responseJSON.errors, 'danger');
            }
        });
    }

    $(document).ready(function () {
        $("#input-role").change(function () {
            var role = $(this).val();
            if (role === 'ADMIN' || role === 'DOORMAN') {
                $(".resident-fields").addClass('d-none');
            } else if (role === 'RESIDENT') {
                $(".resident-fields").removeClass('d-none');
            }
        });

        $("#add-phone").click(function () {
            $("#phone-inputs").append('<div class="input-group mb-2"><input type="text" name="person.phoneNumber" class="form-control" placeholder="Telefone"><div class="input-group-append"><button type="button" class="btn btn-danger remove-phone">Remover</button></div></div>');
        });

        $(document).on("click", ".remove-phone", function () {
            $(this).closest('.input-group').remove();
        });
    });
</script>
</body>
</html>
